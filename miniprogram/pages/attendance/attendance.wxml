<view class="attendance-container">
  <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
  <view class="header">
    <view class="user-info">
      <text class="user-name">{{userInfo.name}}</text>
      <text class="department">{{userInfo.department}}</text>
    </view>
    <view class="time-info">
      <text class="current-time">{{currentTime}}</text>
      <text class="current-date">{{today}}</text>
    </view>
  </view>

  <!-- è·ç¦»çŠ¶æ€æ˜¾ç¤º -->
  <view class="distance-status" wx:if="{{departmentLocation}}">
    <view class="status-indicator {{inRange ? 'in-range' : 'out-range'}}">
      <view class="status-icon">
        <text class="iconfont {{inRange ? 'icon-success' : 'icon-error'}}"></text>
      </view>
      <view class="status-text">
        <text class="status-message">{{distanceInfo}}</text>
        <text class="threshold-info">è·ç¦»é˜ˆå€¼: {{distanceThreshold}}ç±³</text>
      </view>
    </view>
  </view>

  <!-- åœ°å›¾æ˜¾ç¤ºåŒºåŸŸ -->
  <view class="map-section" wx:if="{{showMap}}">
    <!-- æœç´¢åŠŸèƒ½ -->
    <view class="search-section">
      <view class="search-input-group">
        <input 
          class="search-input" 
          placeholder="æœç´¢åœ°ç‚¹" 
          value="{{searchKeyword}}"
          bindinput="onSearchInput"
          bindconfirm="searchPlace"
        />
        <button class="search-btn" bindtap="searchPlace">
          <text class="iconfont icon-search"></text>
        </button>
      </view>
      
      <!-- æœç´¢ç»“æœ -->
      <view class="search-results" wx:if="{{searchResults.length > 0}}">
        <view 
          class="search-result-item" 
          wx:for="{{searchResults}}" 
          wx:key="id"
          bindtap="selectSearchResult"
          data-index="{{index}}"
        >
          <view class="result-name">{{item.name}}</view>
          <view class="result-address">{{item.address}}</view>
          <view class="result-distance" wx:if="{{item.distance}}">{{item.distance}}ç±³</view>
        </view>
      </view>
    </view>

    <view class="map-container">
      <map 
        id="attendance-map"
        longitude="{{longitude}}"
        latitude="{{latitude}}"
        markers="{{markers}}"
        circles="{{circles}}"
        scale="15"
        show-location="true"
        style="width: 100%; height: 300px;"
      ></map>
    </view>
    <view class="map-controls">
      <button class="control-btn" bindtap="refreshLocation">
        <text class="iconfont icon-refresh"></text>
        åˆ·æ–°ä½ç½®
      </button>
    </view>
  </view>

  <!-- åœ°å›¾åˆ‡æ¢æŒ‰é’® -->
  <view class="map-toggle">
    <button class="toggle-btn" bindtap="toggleMap">
      <text class="iconfont icon-map"></text>
      {{showMap ? 'éšè—åœ°å›¾' : 'æ˜¾ç¤ºåœ°å›¾'}}
    </button>
  </view>

  <!-- ä»Šæ—¥è€ƒå‹¤çŠ¶æ€ -->
  <view class="today-status">
    <view class="status-card">
      <view class="status-title">ä»Šæ—¥è€ƒå‹¤</view>
      <view class="status-content">
        <view class="status-item">
          <text class="status-label">ç­¾åˆ°æ—¶é—´:</text>
          <text class="status-value {{checkInTime ? 'has-time' : 'no-time'}}">
            {{checkInTime || 'æœªç­¾åˆ°'}}
          </text>
          <text class="status-badge {{getStatusClass(checkInStatus)}}" wx:if="{{checkInStatus}}">
            {{checkInStatus}}
          </text>
        </view>
        <view class="status-item">
          <text class="status-label">ç­¾é€€æ—¶é—´:</text>
          <text class="status-value {{checkOutTime ? 'has-time' : 'no-time'}}">
            {{checkOutTime || 'æœªç­¾é€€'}}
          </text>
          <text class="status-badge {{getStatusClass(checkOutStatus)}}" wx:if="{{checkOutStatus}}">
            {{checkOutStatus}}
          </text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ‰“å¡æŒ‰é’®åŒºåŸŸ -->
  <view class="attendance-buttons">
    <!-- çŠ¶æ€æç¤º -->
    <view class="status-tip" wx:if="{{statusTip}}">
      <view class="tip-content {{statusTip.type}}">
        <text class="iconfont {{statusTip.type === 'error' ? 'icon-error' : 'icon-warning'}}"></text>
        <text>{{statusTip.message}}</text>
      </view>
    </view>

    <!-- ç­¾åˆ°æŒ‰é’® -->
    <button 
      class="attendance-btn sign-in-btn {{!checkInTime && inRange === true && isReady ? 'active' : 'disabled'}}"
      bindtap="onFaceSignIn"
      disabled="{{!(inRange === true && !checkInTime && isReady)}}"
      loading="{{loading}}"
    >
      <text class="btn-icon">ğŸ“…</text>
      <text class="btn-text">ç­¾åˆ°</text>
      <text class="btn-time">{{currentTime}}</text>
    </button>

    <!-- ç­¾é€€æŒ‰é’® -->
    <button 
      class="attendance-btn sign-out-btn {{checkInTime && !checkOutTime && inRange === true && isReady ? 'active' : 'disabled'}}"
      bindtap="onFaceSignOut"
      disabled="{{!(checkInTime && !checkOutTime && inRange === true && isReady)}}"
      loading="{{loading}}"
    >
      <text class="btn-icon">ğŸ </text>
      <text class="btn-text">ç­¾é€€</text>
      <text class="btn-time">{{currentTime}}</text>
    </button>

    <!-- è°ƒè¯•æŒ‰é’® -->
    <button 
      class="debug-btn"
      bindtap="debugButtonStatus"
      style="margin-top: 10px; font-size: 12px; padding: 5px 10px; background: #f0f0f0;"
    >
      è°ƒè¯•çŠ¶æ€
    </button>
    


    <!-- äººè„¸è¯†åˆ«æ‰“å¡æŒ‰é’® -->
    <!--
    <button 
      class="attendance-btn face-btn {{isReady ? 'active' : 'disabled'}}"
      bindtap="handleAttendance"
      disabled="{{!isReady}}"
      loading="{{isProcessing}}"
    >
      <text class="btn-icon">ğŸ‘¤</text>
      <text class="btn-text">{{isProcessing ? processingText : 'äººè„¸æ‰“å¡'}}</text>
    </button>
    -->
  </view>

  <!-- ä½ç½®ä¿¡æ¯ -->
  <view class="location-info">
    <view class="location-item">
      <text class="location-label">å½“å‰ä½ç½®:</text>
      <text class="location-value">{{location.address || (latitude + ', ' + longitude)}}</text>
    </view>
    <view class="location-item" wx:if="{{departmentLocation}}">
      <text class="location-label">æ‰“å¡ä½ç½®:</text>
      <text class="location-value">{{departmentLocation.address}}</text>
    </view>
  </view>
</view>

<!-- äººè„¸æ‰“å¡å¼¹çª— -->
<view wx:if="{{showFaceModal}}" class="face-modal-mask">
  <!-- å½©è‰²é—ªçƒèƒŒæ™¯ -->
  <view class="colorful-background">
    <view class="color-dot dot1"></view>
    <view class="color-dot dot2"></view>
    <view class="color-dot dot3"></view>
    <view class="color-dot dot4"></view>
    <view class="color-dot dot5"></view>
    <view class="color-dot dot6"></view>
  </view>
  
  <view class="face-modal">
    <!-- æ‘„åƒå¤´åŒºåŸŸ -->
    <camera 
      id="faceCamera" 
      class="face-camera" 
      device-position="front" 
      flash="off" 
      mode="normal" 
      binderror="onCameraError"
      style="filter: brightness(1.3) contrast(1.2);"
    />
    
    <!-- äººè„¸æ£€æµ‹æ¡†Canvasè¦†ç›–å±‚ -->
    <canvas 
      id="faceDetectionCanvas" 
      class="face-detection-canvas"
      canvas-id="faceDetectionCanvas"
      bindtouchstart="onCanvasTouch"
    ></canvas>
    
    <!-- åœ†å½¢é®ç½© -->
    <view class="circle-mask"></view>
    
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <view class="face-modal-header">
      <view class="header-content">
        <text class="face-modal-title">äººè„¸è¯†åˆ«</text>
        <view class="timer-container">
          <text class="timer-icon">â±</text>
          <text class="face-modal-timer">{{faceCheckTimer}}s</text>
        </view>
      </view>
    </view>
    
    <!-- çŠ¶æ€æç¤ºåŒºåŸŸ - åªåœ¨épendingçŠ¶æ€æ˜¾ç¤º -->
    <view class="face-modal-status" wx:if="{{faceCheckStatus !== 'pending'}}">
      <view class="status-container {{faceCheckStatus}}">
        <view class="status-icon">
          <text wx:if="{{faceCheckStatus === 'success'}}" class="icon-success">âœ“</text>
          <text wx:elif="{{faceCheckStatus === 'fail'}}" class="icon-error">âœ—</text>
          <text wx:elif="{{faceCheckStatus === 'timeout'}}" class="icon-timeout">â°</text>
        </view>
        <text class="status-text">
          <text wx:if="{{faceCheckStatus === 'success'}}" class="success-text">æ‰“å¡æˆåŠŸï¼</text>
          <text wx:elif="{{faceCheckStatus === 'fail'}}" class="fail-text">è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•</text>
          <text wx:elif="{{faceCheckStatus === 'timeout'}}" class="timeout-text">è¯†åˆ«è¶…æ—¶ï¼Œè¯·é‡è¯•</text>
        </text>
      </view>
    </view>
    
    <!-- åº•éƒ¨æ“ä½œ -->
    <view class="face-modal-footer">
      <button class="face-modal-exit" bindtap="onFaceModalExit">
        <text class="exit-icon">âœ•</text>
        <text class="exit-text">é€€å‡º</text>
      </button>
    </view>
    
    <!-- ç®€å•çš„å¼•å¯¼æç¤º - åªåœ¨pendingçŠ¶æ€æ˜¾ç¤º -->
    <view class="face-modal-guide" wx:if="{{faceCheckStatus === 'pending'}}">
      <view class="guide-content">
        <text class="guide-text">è¯·å°†è„¸éƒ¨å¯¹å‡†åœ†åœˆä¸­å¿ƒ</text>
        <text class="detection-status" wx:if="{{isVerifying}}">ğŸ” æ­£åœ¨éªŒè¯...</text>
        <text class="detection-status" wx:elif="{{faceBoxes.length > 0}}">âœ“ æ£€æµ‹åˆ°äººè„¸</text>
        <text class="detection-status" wx:else>â³ æ­£åœ¨æ£€æµ‹...</text>
      </view>
    </view>
  </view>
</view> 
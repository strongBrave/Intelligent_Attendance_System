# 自动考勤系统使用说明

## 功能概述

自动考勤系统会根据每个部门设置的缺勤时间和晚退时间，自动为超时未打卡的员工创建考勤记录，防止员工在超时后仍能打卡，确保考勤数据的准确性。

## 核心功能

### 1. 自动缺勤记录
- **触发条件**：当前时间超过部门的缺勤阈值时间
- **检查对象**：该部门所有员工
- **处理逻辑**：为今天没有签到记录的员工自动创建缺勤记录
- **记录内容**：
  - 类型：`sign_in`（签到）
  - 状态：`absent`（缺勤）
  - 时间：部门缺勤阈值时间
  - 备注：`[系统自动]: 超过缺勤时间(HH:MM)未签到，自动标记为缺勤`

### 2. 自动晚退记录
- **触发条件**：当前时间超过部门的晚退阈值时间
- **检查对象**：已签到但未签退的员工
- **处理逻辑**：为已签到但未签退的员工自动创建晚退记录
- **记录内容**：
  - 类型：`sign_out`（签退）
  - 状态：`late_leave`（晚退）
  - 时间：部门晚退阈值时间
  - 备注：`[系统自动]: 超过晚退时间(HH:MM)未签退，自动标记为晚退`

## 运行模式

### 1. 定时运行（推荐）
系统会在以下时间点自动执行检查：
- **10:30** - 上午检查缺勤
- **12:00** - 中午检查
- **15:00** - 下午检查
- **18:30** - 下班后检查晚退
- **20:00** - 晚上检查
- **22:00** - 夜间检查

### 2. 手动测试
可以手动运行一次检查，用于测试系统是否正常工作。

## 使用方法

### 步骤1：安装依赖
确保已安装所有必要的Python库：
```bash
pip install -r requirements.txt
```

### 步骤2：测试运行
在正式启动前，建议先进行测试：

**Windows用户：**
```cmd
双击运行 test_auto_attendance.bat
```

**Linux/Mac用户：**
```bash
python auto_attendance.py --once
```

### 步骤3：正式启动
**Windows用户：**
```cmd
双击运行 start_auto_attendance.bat
```

**Linux/Mac用户：**
```bash
python auto_attendance.py
```

## 系统日志

系统运行时会输出详细的日志信息：

```
[2024-01-15 10:30:00] 开始检查缺勤记录...
处理部门: 技术部, 缺勤阈值: 09:30
  创建缺勤记录: 张三 (13800138000)
  创建缺勤记录: 李四 (13800138001)
[2024-01-15 10:30:02] 缺勤记录检查完成

[2024-01-15 18:30:00] 开始检查晚退记录...
处理部门: 技术部, 晚退阈值: 18:00
  创建晚退记录: 王五 (13800138002)
[2024-01-15 18:30:01] 晚退记录检查完成
```

## 配置要求

### 部门设置
在管理后台确保每个部门都正确设置了：
- **缺勤阈值** (`absent_threshold`)：格式 "HH:MM"，如 "09:30"
- **晚退阈值** (`late_leave_threshold`)：格式 "HH:MM"，如 "18:00"

### 数据库要求
确保 `attendance` 表已包含 `remark` 字段：
```sql
ALTER TABLE attendance ADD COLUMN remark VARCHAR(256);
```

## 防重复机制

### 后端API保护
系统已在后端API层面实现防重复打卡：
- 签到API会检查今日是否已有签到记录
- 签退API会检查今日是否已有签退记录
- 如果已有记录，返回错误信息拒绝打卡

### 前端界面保护
微信小程序会根据考勤记录状态自动禁用打卡按钮：
- 已签到：禁用签到按钮
- 已签退：禁用签退按钮

## 运行环境

### 系统要求
- Python 3.7+
- Flask应用已正常运行
- 数据库连接正常

### 依赖库
```
schedule
flask
flask-sqlalchemy
其他项目依赖...
```

## 注意事项

1. **运行位置**：必须在 `backend` 目录下运行
2. **权限要求**：需要数据库写入权限
3. **网络要求**：需要访问数据库的网络连接
4. **时区设置**：确保服务器时区设置正确
5. **持续运行**：定时模式需要保持程序持续运行

## 故障排除

### 常见问题

**1. 模块导入错误**
```
ImportError: No module named 'app'
```
- 解决：确保在 `backend` 目录下运行脚本

**2. 数据库连接失败**
```
sqlalchemy.exc.OperationalError
```
- 解决：检查数据库连接配置和服务状态

**3. schedule库未安装**
```
ModuleNotFoundError: No module named 'schedule'
```
- 解决：运行 `pip install schedule`

### 调试模式
如需调试，可以修改脚本中的日志输出级别，或添加更多调试信息。

## 扩展功能

可根据业务需求扩展以下功能：
- 节假日排除逻辑
- 邮件/短信通知
- 更复杂的考勤规则
- 数据统计和报表

## 技术支持

如遇到问题，请检查：
1. 系统日志输出
2. 数据库表结构
3. 部门时间配置
4. Flask应用运行状态 